---
title: 'Lecture notes: Reshaping with tidyr'
author: ~
date: '2019-09-23'
slug: lecture-notes-reshaping-with-tidyr
categories: []
tags: []
---



<div id="resources" class="section level1">
<h1>Resources</h1>
<ul>
<li>Software Carpentry <a href="http://swcarpentry.github.io/r-novice-gapminder/14-tidyr/index.html">tidyr lesson</a>
<ul>
<li><a href="https://raw.githubusercontent.com/swcarpentry/r-novice-gapminder/gh-pages/_episodes_rmd/data/gapminder_wide.csv">Gapminder in wide format</a></li>
<li>Remember that the “standard” (long-ish) <code>gapminder</code> data set can be loaded from the <strong>gapminder</strong> package</li>
</ul></li>
<li><a href="https://tidyr.tidyverse.org/">Tidyr homepage</a></li>
<li>The <a href="https://r4ds.had.co.nz/tidy-data.html">tidy data chapter</a> in R for Data Science.</li>
</ul>
<div id="useful-ggplot2-worked-examples" class="section level2">
<h2>Useful ggplot2 worked examples</h2>
<ul>
<li>Claus Wilke’s guide to <a href="https://wilkelab.org/practicalgg/">publishable ggplots</a>. (This isn’t relevant to today’s lesson, but it’s a useful resource).</li>
</ul>
</div>
</div>
<div id="reshaping-data-with-tidyr" class="section level1">
<h1>Reshaping data with <strong>tidyr</strong></h1>
<p>Think about what a ‘long’ format data frame is: each row is an observation, and each column is a variable. In its purest form, a long-format data frame will have a single column containing data, and the rest of the columns will be descriptors of that data, or ID variables.</p>
<p>Does <code>gapminder</code> meet those criteria?</p>
<pre class="r"><code>library(tidyverse)
library(gapminder)
glimpse(gapminder)</code></pre>
<pre><code>## Observations: 1,704
## Variables: 6
## $ country   &lt;fct&gt; Afghanistan, Afghanistan, Afghanistan, Afghanistan, Af…
## $ continent &lt;fct&gt; Asia, Asia, Asia, Asia, Asia, Asia, Asia, Asia, Asia, …
## $ year      &lt;int&gt; 1952, 1957, 1962, 1967, 1972, 1977, 1982, 1987, 1992, …
## $ lifeExp   &lt;dbl&gt; 28.801, 30.332, 31.997, 34.020, 36.088, 38.438, 39.854…
## $ pop       &lt;int&gt; 8425333, 9240934, 10267083, 11537966, 13079460, 148803…
## $ gdpPercap &lt;dbl&gt; 779.4453, 820.8530, 853.1007, 836.1971, 739.9811, 786.…</code></pre>
<p>Not really! Three of the rows are descriptors (<code>country</code>, <code>continent</code>, and <code>year</code>), while the rest contain data (<code>pop</code>, <code>lifeExp</code>, and <code>gdpPercap</code>). Let’s use the <strong>tidyr</strong> package, which we have loaded via <strong>tidyverse</strong>, to learn how to reshape the data.</p>
<p><strong>IMPORTANT NOTE:</strong> Some new functions, <code>pivot_longer()</code> and <code>pivot_wider()</code> have been added to tidyverse, as described <a href="https://tidyr.tidyverse.org/articles/pivot.html">here</a>. These are meant to be more intuitive than what I describe below. It might be worth your time to experiment with these a bit to see how you like them compared to <code>spread()</code> and <code>gather()</code>.</p>
<p>We’ll often get data in a wide format, in part because that format makes sense for Excel, and it is often more human-readable. I’ll use this opportuntiy to show a neat feature of the <strong>readr</strong> package’s <code>read_csv()</code> (note the difference from base R’s <code>read.csv()</code>).</p>
<pre class="r"><code>gap_wide &lt;- read_csv(&quot;https://raw.githubusercontent.com/swcarpentry/r-novice-gapminder/gh-pages/_episodes_rmd/data/gapminder_wide.csv&quot;)
glimpse(gap_wide) # display the number of columns</code></pre>
<pre><code>## Observations: 142
## Variables: 38
## $ continent      &lt;chr&gt; &quot;Africa&quot;, &quot;Africa&quot;, &quot;Africa&quot;, &quot;Africa&quot;, &quot;Africa&quot;,…
## $ country        &lt;chr&gt; &quot;Algeria&quot;, &quot;Angola&quot;, &quot;Benin&quot;, &quot;Botswana&quot;, &quot;Burkin…
## $ gdpPercap_1952 &lt;dbl&gt; 2449.0082, 3520.6103, 1062.7522, 851.2411, 543.25…
## $ gdpPercap_1957 &lt;dbl&gt; 3013.9760, 3827.9405, 959.6011, 918.2325, 617.183…
## $ gdpPercap_1962 &lt;dbl&gt; 2550.8169, 4269.2767, 949.4991, 983.6540, 722.512…
## $ gdpPercap_1967 &lt;dbl&gt; 3246.9918, 5522.7764, 1035.8314, 1214.7093, 794.8…
## $ gdpPercap_1972 &lt;dbl&gt; 4182.6638, 5473.2880, 1085.7969, 2263.6111, 854.7…
## $ gdpPercap_1977 &lt;dbl&gt; 4910.4168, 3008.6474, 1029.1613, 3214.8578, 743.3…
## $ gdpPercap_1982 &lt;dbl&gt; 5745.1602, 2756.9537, 1277.8976, 4551.1421, 807.1…
## $ gdpPercap_1987 &lt;dbl&gt; 5681.3585, 2430.2083, 1225.8560, 6205.8839, 912.0…
## $ gdpPercap_1992 &lt;dbl&gt; 5023.2166, 2627.8457, 1191.2077, 7954.1116, 931.7…
## $ gdpPercap_1997 &lt;dbl&gt; 4797.2951, 2277.1409, 1232.9753, 8647.1423, 946.2…
## $ gdpPercap_2002 &lt;dbl&gt; 5288.0404, 2773.2873, 1372.8779, 11003.6051, 1037…
## $ gdpPercap_2007 &lt;dbl&gt; 6223.3675, 4797.2313, 1441.2849, 12569.8518, 1217…
## $ lifeExp_1952   &lt;dbl&gt; 43.077, 30.015, 38.223, 47.622, 31.975, 39.031, 3…
## $ lifeExp_1957   &lt;dbl&gt; 45.685, 31.999, 40.358, 49.618, 34.906, 40.533, 4…
## $ lifeExp_1962   &lt;dbl&gt; 48.303, 34.000, 42.618, 51.520, 37.814, 42.045, 4…
## $ lifeExp_1967   &lt;dbl&gt; 51.407, 35.985, 44.885, 53.298, 40.697, 43.548, 4…
## $ lifeExp_1972   &lt;dbl&gt; 54.518, 37.928, 47.014, 56.024, 43.591, 44.057, 4…
## $ lifeExp_1977   &lt;dbl&gt; 58.014, 39.483, 49.190, 59.319, 46.137, 45.910, 4…
## $ lifeExp_1982   &lt;dbl&gt; 61.368, 39.942, 50.904, 61.484, 48.122, 47.471, 5…
## $ lifeExp_1987   &lt;dbl&gt; 65.799, 39.906, 52.337, 63.622, 49.557, 48.211, 5…
## $ lifeExp_1992   &lt;dbl&gt; 67.744, 40.647, 53.919, 62.745, 50.260, 44.736, 5…
## $ lifeExp_1997   &lt;dbl&gt; 69.152, 40.963, 54.777, 52.556, 50.324, 45.326, 5…
## $ lifeExp_2002   &lt;dbl&gt; 70.994, 41.003, 54.406, 46.634, 50.650, 47.360, 4…
## $ lifeExp_2007   &lt;dbl&gt; 72.301, 42.731, 56.728, 50.728, 52.295, 49.580, 5…
## $ pop_1952       &lt;dbl&gt; 9279525, 4232095, 1738315, 442308, 4469979, 24456…
## $ pop_1957       &lt;dbl&gt; 10270856, 4561361, 1925173, 474639, 4713416, 2667…
## $ pop_1962       &lt;dbl&gt; 11000948, 4826015, 2151895, 512764, 4919632, 2961…
## $ pop_1967       &lt;dbl&gt; 12760499, 5247469, 2427334, 553541, 5127935, 3330…
## $ pop_1972       &lt;dbl&gt; 14760787, 5894858, 2761407, 619351, 5433886, 3529…
## $ pop_1977       &lt;dbl&gt; 17152804, 6162675, 3168267, 781472, 5889574, 3834…
## $ pop_1982       &lt;dbl&gt; 20033753, 7016384, 3641603, 970347, 6634596, 4580…
## $ pop_1987       &lt;dbl&gt; 23254956, 7874230, 4243788, 1151184, 7586551, 512…
## $ pop_1992       &lt;dbl&gt; 26298373, 8735988, 4981671, 1342614, 8878303, 580…
## $ pop_1997       &lt;dbl&gt; 29072015, 9875024, 6066080, 1536536, 10352843, 61…
## $ pop_2002       &lt;dbl&gt; 31287142, 10866106, 7026113, 1630347, 12251209, 7…
## $ pop_2007       &lt;dbl&gt; 33333216, 12420476, 8078314, 1639131, 14326203, 8…</code></pre>
<p>Yikes: 38 columns.</p>
<p>Let’s turn this into a long data frame. To do this, we need to distinguish between columns that contain data, and columns that serve as identifiers for the data. In this example, <code>continent</code> and <code>country</code> are clearly identifiers. <code>year</code> is a bit of a judgement call - it has a numeric value, so it kind of looks like data. However, it isn’t really something you measure, like population or life expectency.</p>
<p>In this example, we’ll use the <code>starts_with()</code> functions to define the columns that count as data: any column whose name starts with “pop”, “lifeExp”, or “gdpPercap”.</p>
<pre class="r"><code>gap_long &lt;- gap_wide %&gt;%
  gather(key = obstype_year, value = obs_values, 
         starts_with(&#39;pop&#39;), starts_with(&#39;lifeExp&#39;), starts_with(&#39;gdpPercap&#39;))
glimpse(gap_long)</code></pre>
<pre><code>## Observations: 5,112
## Variables: 4
## $ continent    &lt;chr&gt; &quot;Africa&quot;, &quot;Africa&quot;, &quot;Africa&quot;, &quot;Africa&quot;, &quot;Africa&quot;, &quot;…
## $ country      &lt;chr&gt; &quot;Algeria&quot;, &quot;Angola&quot;, &quot;Benin&quot;, &quot;Botswana&quot;, &quot;Burkina …
## $ obstype_year &lt;chr&gt; &quot;pop_1952&quot;, &quot;pop_1952&quot;, &quot;pop_1952&quot;, &quot;pop_1952&quot;, &quot;po…
## $ obs_values   &lt;dbl&gt; 9279525, 4232095, 1738315, 442308, 4469979, 2445618…</code></pre>
<p>For my money, the syntax is easier to understand if we define the columns that <em>don’t</em> contain data, using the <code>-</code> operator:</p>
<pre class="r"><code>gap_long_alt &lt;- gap_wide %&gt;%
  gather(key = obstype_year, value = obs_values,
         -continent, -country)
glimpse(gap_long_alt)</code></pre>
<pre><code>## Observations: 5,112
## Variables: 4
## $ continent    &lt;chr&gt; &quot;Africa&quot;, &quot;Africa&quot;, &quot;Africa&quot;, &quot;Africa&quot;, &quot;Africa&quot;, &quot;…
## $ country      &lt;chr&gt; &quot;Algeria&quot;, &quot;Angola&quot;, &quot;Benin&quot;, &quot;Botswana&quot;, &quot;Burkina …
## $ obstype_year &lt;chr&gt; &quot;gdpPercap_1952&quot;, &quot;gdpPercap_1952&quot;, &quot;gdpPercap_1952…
## $ obs_values   &lt;dbl&gt; 2449.0082, 3520.6103, 1062.7522, 851.2411, 543.2552…</code></pre>
<p>This has the same effefct, but note that the values of <code>obstype_year</code> are ordered differently: the first row contains <code>gdpPercap_1952</code> instead of <code>pop_1952</code>. However, in general, <em>the order of rows of a data frame doesn’t matter</em>, so this is not a big deal.</p>
<p>Note that this is not a terribly useful format for our data: the original, not-quite-long format of <code>gapminder</code> makes more sense, because population and life expetency are different quantities with different units, and they don’t really belong in the same column. For this, we can use the <code>separate()</code> function. Note that the column names are in quotation makrs here, because they’re the names of new columns rather than existing columns.</p>
<pre class="r"><code>gap_intermediate &lt;- gap_long %&gt;% 
  separate(obstype_year, into = c(&#39;obs_type&#39;, &#39;year&#39;), sep = &quot;_&quot;)
glimpse(gap_intermediate)</code></pre>
<pre><code>## Observations: 5,112
## Variables: 5
## $ continent  &lt;chr&gt; &quot;Africa&quot;, &quot;Africa&quot;, &quot;Africa&quot;, &quot;Africa&quot;, &quot;Africa&quot;, &quot;Af…
## $ country    &lt;chr&gt; &quot;Algeria&quot;, &quot;Angola&quot;, &quot;Benin&quot;, &quot;Botswana&quot;, &quot;Burkina Fa…
## $ obs_type   &lt;chr&gt; &quot;pop&quot;, &quot;pop&quot;, &quot;pop&quot;, &quot;pop&quot;, &quot;pop&quot;, &quot;pop&quot;, &quot;pop&quot;, &quot;pop…
## $ year       &lt;chr&gt; &quot;1952&quot;, &quot;1952&quot;, &quot;1952&quot;, &quot;1952&quot;, &quot;1952&quot;, &quot;1952&quot;, &quot;1952…
## $ obs_values &lt;dbl&gt; 9279525, 4232095, 1738315, 442308, 4469979, 2445618, …</code></pre>
<p>Lastly, the years are listed as characters. We’ll want to reformulate them as numbers. We could do this using <code>dplyr::mutate()</code> to redefine the column, but it is just as easy to use <code>$</code> syntax since we’re not piping together any statements.</p>
<pre class="r"><code>gap_intermediate$year &lt;- as.integer(gap_intermediate$year)
str(gap_intermediate$year)</code></pre>
<pre><code>##  int [1:5112] 1952 1952 1952 1952 1952 1952 1952 1952 1952 1952 ...</code></pre>
</div>
